{{ define "main" }}

{{/* === –ó–∞–≥—Ä—É–∂–∞–µ–º CSV —Å –∞–∫—Ç—É–∞–ª—å–Ω—ã–º–∏ —Ü–µ–Ω–∞–º–∏ –∏ –æ—Å—Ç–∞—Ç–∫–∞–º–∏ === */}}
{{ $csv := resources.Get "products.csv" | transform.Unmarshal }}
{{ $map := dict }}
{{ range $csv }}
  {{ $key := lower (printf "%v" (index . 1)) }}
  {{ $map = merge $map (dict $key (dict "price" (index . 2) "in_stock" (index . 3))) }}
{{ end }}

{{/* === –°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ === */}}
{{ $pages := where .Site.RegularPages "Section" "tapestry" }}

{{/* === –ü–æ–¥—Å—á—ë—Ç —Å—Ç–∞—Ç—É—Å–æ–≤ (–¥–ª—è –±–µ–π–¥–∂–µ–π –≤ —Ñ–∏–ª—å—Ç—Ä–µ) === */}}
{{ $total := len $pages }}
{{ $inCount := 0 }}
{{ range $pages }}
  {{ $base := .File.BaseFileName | lower }}
  {{ $raw := "" }}
  {{ with index $map $base }}{{ $raw = printf "%v" (index . "in_stock") }}{{ end }}
  {{ $s := lower (strings.TrimSpace $raw) }}
  {{ $isIn := and (ne $s "") (ne $s "0") (ne $s "false") (ne $s "–Ω–µ—Ç") (ne $s "no") }}
  {{ if $isIn }}{{ $inCount = add $inCount 1 }}{{ end }}
{{ end }}
{{ $outCount := sub $total $inCount }}

<div class="layout-content-container flex flex-col max-w-[1280px] flex-1 mx-auto">

  <!-- Hero-—Å–µ–∫—Ü–∏—è -->
  <section class="@container @[480px]:p-4">
    <div class="flex min-h-[280px] flex-col gap-6 bg-cover bg-center bg-no-repeat @[280px]:gap-8 @[480px]:rounded-xl items-center justify-center p-4"
         style='background-image: linear-gradient(rgba(0, 0, 0, 0.1) 0%, rgba(0, 0, 0, 0.4) 100%), url("{{ "images/hero.jpg" | absURL }}");'>

      <div class="flex flex-col gap-2 text-center">
        <h1 class="text-white text-4xl font-black leading-tight tracking-[-0.033em] @[480px]:text-5xl">–°—Ç–∏–ª—å –∂–∏–∑–Ω–∏</h1>
        <h2 class="text-white text-sm font-normal @[480px]:text-base">
          –ü–æ–¥–±–æ—Ä–∫–∞ –≥–æ–±–µ–ª–µ–Ω–æ–≤—ã—Ö –∫–æ–≤—Ä–æ–≤ —Å —Ç–æ–ø–æ–≤—ã–º–∏ –∞–Ω–∏–º–µ.
        </h2>
      </div>

      <a href="https://t.me/wa_gi_ch"
         target="_blank" rel="noopener"
         aria-label="–ù–∞—à Telegram-–∫–∞–Ω–∞–ª"
         class="inline-flex min-w-[84px] max-w-[480px] items-center justify-center
                h-10 px-4 rounded-2xl bg-red-600 text-white text-sm
                font-medium italic tracking-wide
                hover:bg-red-700 hover:shadow-md active:scale-[0.98] transition">

        <svg aria-hidden="true" class="w-4 h-4 mr-2" viewBox="0 0 240 240" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
          <path d="M120 0C53.7 0 0 53.7 0 120s53.7 120 120 120 120-53.7 120-120S186.3 0 120 0zm56.6 83.5l-17.9 84.6c-1.3 6-4.9 7.5-10 4.7l-27.6-20.3-13.3 12.8c-1.5 1.5-2.8 2.8-5.7 2.8l2-28.7 52.3-47.3c2.3-2.1-.5-3.3-3.6-1.2l-64.6 40.7-27.8-8.7c-6-1.9-6.1-6-1.3-8.8l108.6-41.9c5.1-1.9 9.6 1.2 8 8.9z"/>
        </svg>
        –ù–∞—à&nbsp;–¢–ì–ö
      </a>
    </div>
  </section>

  <!-- –û–ø–∏—Å–∞–Ω–∏–µ -->
  <section class="mt-8 px-4 text-center text-neutral-700 text-base leading-relaxed">
    <p class="max-w-[720px] mx-auto">
      –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –Ω–∞—à —É—é—Ç–Ω—ã–π —É–≥–æ–ª–æ–∫ –∞–Ω–∏–º–µ-–¥–µ–∫–æ—Ä–∞! –ó–¥–µ—Å—å –≤—ã –Ω–∞–π–¥—ë—Ç–µ –≥–æ–±–µ–ª–µ–Ω—ã —Å –ª—é–±–∏–º—ã–º–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞–º–∏ ‚Äî —Å—Ç–∏–ª—å–Ω—ã–π —Å–ø–æ—Å–æ–± —É–∫—Ä–∞—Å–∏—Ç—å –∫–æ–º–Ω–∞—Ç—É, –≤–¥–æ—Ö–Ω–æ–≤–∏—Ç—å—Å—è —ç—Å—Ç–µ—Ç–∏–∫–æ–π –∏ —Å–¥–µ–ª–∞—Ç—å –ø–æ–¥–∞—Ä–æ–∫ —Ñ–∞–Ω–∞—Ç—É.
      <br/>
      –í—Å–µ –≥–æ–±–µ–ª–µ–Ω—ã –≤—ã–ø–æ–ª–Ω–µ–Ω—ã –≤ –≤—ã—Å–æ–∫–æ–º –∫–∞—á–µ—Å—Ç–≤–µ, —Ä–∞–∑–º–µ—Ä ‚Äî <strong>160√ó130 —Å–º</strong>, –º–∞—Ç–µ—Ä–∏–∞–ª ‚Äî <strong>70% –ø–æ–ª–∏—ç—Å—Ç–µ—Ä –∏ 30% —Ö–ª–æ–ø–æ–∫</strong>.
    </p>
  </section>

  <!-- –§–∏–ª—å—Ç—Ä—ã -->
  <section aria-label="–§–∏–ª—å—Ç—Ä—ã –∫–∞—Ç–∞–ª–æ–≥–∞" class="mt-8 px-4 sticky top-2 z-20">
    <div class="rounded-2xl border border-gray-200 bg-white/95 backdrop-blur p-4 shadow-sm">
      <div class="flex flex-col gap-3 md:flex-row md:items-end md:justify-between">
        <div class="flex-1">
          <label for="catalog-filter-q" class="block text-sm font-semibold text-gray-900">–ü–æ–∏—Å–∫</label>
          <div class="mt-2 flex items-center gap-2">
            <input id="catalog-filter-q"
                   type="search"
                   inputmode="search"
                   placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: Naruto, Berserk, Jujutsu..."
                   class="w-full rounded-xl border-gray-200 bg-white px-3 py-2 text-sm focus:border-red-600 focus:ring-red-600" />
            <button id="catalog-filter-clear"
                    type="button"
                    class="shrink-0 inline-flex items-center justify-center h-10 px-3 rounded-xl border border-gray-200 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 active:scale-[0.98] transition">
              –°–±—Ä–æ—Å
            </button>
          </div>
        </div>

        <!-- –ß–∏–ø—Å—ã: –Ω–∞ –º–æ–±–∏–ª–∫–µ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª -->
        <div class="flex gap-2 overflow-x-auto [-webkit-overflow-scrolling:touch] md:overflow-visible md:flex-wrap">
          <button type="button" data-stock-filter="all"
                  class="inline-flex items-center justify-center h-10 px-4 rounded-full border border-red-600 bg-red-600 text-white text-sm font-semibold hover:shadow-sm active:scale-[0.98] transition whitespace-nowrap"
                  aria-pressed="true">
            –í—Å–µ
          </button>
          <button type="button" data-stock-filter="in"
                  class="inline-flex items-center justify-center h-10 px-4 rounded-full border border-gray-200 bg-white text-gray-800 text-sm font-semibold hover:bg-gray-50 hover:shadow-sm active:scale-[0.98] transition whitespace-nowrap"
                  aria-pressed="false">
            –í –Ω–∞–ª–∏—á–∏–∏
          </button>
          <button type="button" data-stock-filter="out"
                  class="inline-flex items-center justify-center h-10 px-4 rounded-full border border-gray-200 bg-white text-gray-800 text-sm font-semibold hover:bg-gray-50 hover:shadow-sm active:scale-[0.98] transition whitespace-nowrap"
                  aria-pressed="false">
            –ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏
          </button>
        </div>
      </div>

      <div class="mt-3 flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between text-sm text-gray-600">
        <p>
          –ü–æ–∫–∞–∑–∞–Ω–æ: <span id="catalog-visible-count" class="font-semibold text-gray-900">0</span>
          –∏–∑ <span id="catalog-total-count" class="font-semibold text-gray-900">{{ $total }}</span>
        </p>

        <div class="flex flex-wrap items-center gap-2">
          <span class="inline-flex items-center gap-2 rounded-full bg-green-50 px-3 py-1 text-xs font-semibold text-green-700">
            <span class="h-2 w-2 rounded-full bg-green-600"></span>
            –í –Ω–∞–ª–∏—á–∏–∏: {{ $inCount }}
          </span>
          <span class="inline-flex items-center gap-2 rounded-full bg-red-50 px-3 py-1 text-xs font-semibold text-red-700">
            <span class="h-2 w-2 rounded-full bg-red-600"></span>
            –ù–µ—Ç: {{ $outCount }}
          </span>
        </div>
      </div>
    </div>
  </section>

  <!-- –ö–∞—Ç–∞–ª–æ–≥ -->
  <section id="catalog">
    <h2 class="text-[#141414] text-[22px] font-bold tracking-[-0.015em] px-4 pb-3 pt-10">–ö–∞—Ç–∞–ª–æ–≥ –∞–Ω–∏–º–µ-–≥–æ–±–µ–ª–µ–Ω–æ–≤</h2>

    <div id="catalog-grid" class="grid grid-cols-2 md:grid-cols-3 gap-6 px-4">
      {{ range $pages }}
        {{ $base := .File.BaseFileName | lower }}

        {{/* –°—Ç–æ–∫ –∏–∑ CSV */}}
        {{ $raw := "" }}
        {{ with index $map $base }}{{ $raw = printf "%v" (index . "in_stock") }}{{ end }}
        {{ $s := lower (strings.TrimSpace $raw) }}
        {{ $isIn := and (ne $s "") (ne $s "0") (ne $s "false") (ne $s "–Ω–µ—Ç") (ne $s "no") }}

        {{/* –ö–∞—Ä—Ç–∏–Ω–∫–∞ normal/soldout */}}
        {{ $normal := resources.Get (print "images/" $base ".jpg") }}
        {{ $sold   := resources.Get (print "images/" $base "___soldout.jpg") }}
        {{ $chosen := cond $isIn $normal (or $sold $normal) }}

        <a href="{{ .RelPermalink }}"
           data-product-card="1"
           data-instock="{{ cond $isIn "1" "0" }}"
           data-search="{{ lower (printf "%s %s" .Title $base) }}"
           class="flex flex-col gap-2 rounded-xl overflow-hidden shadow hover:shadow-lg transition bg-white">

          <div class="relative">
            {{ with $chosen }}
              {{ $resized := .Fit "400x500" }}
              <div class="w-full bg-center bg-no-repeat bg-cover aspect-[4/5]"
                   style='background-image: url("{{ $resized.RelPermalink }}");'>
              </div>
            {{ else }}
              <div class="w-full bg-gray-200 flex items-center justify-center aspect-[4/5]">
                <span class="text-gray-500 text-sm">‚õî –ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</span>
              </div>
            {{ end }}

            {{ if $isIn }}
              <span class="absolute top-2 left-2 inline-flex items-center gap-1 rounded-full bg-green-600/95 px-3 py-1 text-xs font-semibold text-white shadow">
                ‚úì –í –Ω–∞–ª–∏—á–∏–∏
              </span>
            {{ else }}
              <span class="absolute top-2 left-2 inline-flex items-center gap-1 rounded-full bg-red-600/95 px-3 py-1 text-xs font-semibold text-white shadow">
                ‚è≥ –ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏
              </span>
            {{ end }}
          </div>

          <div class="p-3">
            <h3 class="text-[#141414] text-base font-semibold">{{ .Title }}</h3>

            <div class="mt-2 flex items-center justify-between gap-2">
              {{ with index $map $base }}
                <p class="text-neutral-500 text-sm">üí∞ {{ .price }}‚ÇΩ</p>
              {{ else }}
                <p class="text-gray-400 text-sm">–¶–µ–Ω–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞</p>
              {{ end }}

              {{ if $isIn }}
                <span class="text-xs font-semibold text-green-700 bg-green-50 border border-green-200 rounded-full px-2 py-1">
                  –º–æ–∂–Ω–æ –∑–∞–±—Ä–∞—Ç—å
                </span>
              {{ else }}
                <span class="text-xs font-semibold text-red-700 bg-red-50 border border-red-200 rounded-full px-2 py-1">
                  —É—Ç–æ—á–Ω–∏—Ç—å
                </span>
              {{ end }}
            </div>
          </div>
        </a>
      {{ end }}
    </div>
  </section>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const cards = Array.from(document.querySelectorAll('[data-product-card="1"]'));
      if (!cards.length) return;

      const qInput = document.getElementById('catalog-filter-q');
      const clearBtn = document.getElementById('catalog-filter-clear');
      const countEl = document.getElementById('catalog-visible-count');
      const totalEl = document.getElementById('catalog-total-count');
      const chipBtns = Array.from(document.querySelectorAll('[data-stock-filter]'));

      let mode = 'all'; // all | in | out

      function setActiveChip() {
        chipBtns.forEach((btn) => {
          const active = (btn.dataset.stockFilter || 'all') === mode;
          btn.setAttribute('aria-pressed', active ? 'true' : 'false');

          btn.classList.toggle('bg-red-600', active);
          btn.classList.toggle('text-white', active);
          btn.classList.toggle('border-red-600', active);

          btn.classList.toggle('bg-white', !active);
          btn.classList.toggle('text-gray-800', !active);
          btn.classList.toggle('border-gray-200', !active);
        });
      }

      function apply() {
        const q = (qInput?.value || '').trim().toLowerCase();
        let visible = 0;

        cards.forEach((card) => {
          const inStock = card.dataset.instock === '1';
          const hay = (card.dataset.search || '').toLowerCase();

          const matchText = !q || hay.includes(q);
          const matchStock =
            mode === 'all' ||
            (mode === 'in' ? inStock : !inStock);

          const show = matchText && matchStock;
          card.classList.toggle('hidden', !show);
          if (show) visible += 1;
        });

        if (countEl) countEl.textContent = String(visible);
        if (totalEl) totalEl.textContent = String(cards.length);
      }

      chipBtns.forEach((btn) => {
        btn.addEventListener('click', () => {
          mode = btn.dataset.stockFilter || 'all';
          setActiveChip();
          apply();
        });
      });

      qInput?.addEventListener('input', apply);

      clearBtn?.addEventListener('click', () => {
        if (qInput) qInput.value = '';
        mode = 'all';
        setActiveChip();
        apply();
      });

      setActiveChip();
      apply();
    });
  </script>

</div>

{{ end }}

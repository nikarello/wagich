name: üì¶ –û–±–Ω–æ–≤–∏—Ç—å –∫–∞—Ç–∞–ª–æ–≥ –∏–∑ Google Sheets

on:
  workflow_dispatch:

jobs:
  update-catalog:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: üì• Checkout (main)
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: ‚¨áÔ∏è Download CSV (Google Sheets export)
        env:
          GSHEET_ID: ${{ secrets.GSHEET_ID }}
          GSHEET_GID: ${{ secrets.GSHEET_GID }}
        run: |
          set -euo pipefail

          mkdir -p assets

          CSV_URL="https://docs.google.com/spreadsheets/d/${GSHEET_ID}/export?format=csv&gid=${GSHEET_GID}"
          echo "Downloading: $CSV_URL"

          curl -fSL "$CSV_URL" -o assets/products.csv

          # If we got HTML instead of CSV ‚Äî stop and do not commit
          if head -n 5 assets/products.csv | grep -qiE '<!doctype|<html'; then
            echo "ERROR: Downloaded HTML instead of CSV."
            echo "Make the sheet public/published and check GSHEET_ID/GSHEET_GID."
            head -n 30 assets/products.csv
            exit 1
          fi

          # Remove UTF-8 BOM if present
          sed -i '1s/^\xEF\xBB\xBF//' assets/products.csv

      - name: üöÄ Commit and push to main (only if changed)
        run: |
          set -euo pipefail

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add assets/products.csv

          if git diff --cached --quiet; then
            echo "No changes in products.csv"
            exit 0
          fi

          git commit -m "auto: –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–∞–ª–æ–≥–∞"
          git push origin HEAD:main
